@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    Layout = "_Layout";

    ViewBag.Title = "Full Admin Dashboard";
    var genres = ViewBag.Genres as IEnumerable<mymusic_app.Models.Genre>;
    var artists = ViewBag.Artists as IEnumerable<mymusic_app.Models.Artist>;
    var albums = ViewBag.Albums as IEnumerable<mymusic_app.Models.Album>;
    var songs = ViewBag.Songs as IEnumerable<mymusic_app.Models.Song>;
}

<div class="main-wrapper">
    <div class="container-fluid">
        <div class="row align-items-center mb-3">
            <div class="col">
                <h1 class="fw-bold text-dark m-0 fs-4">Full Admin Dashboard</h1>
                <p class="text-muted small">Manage your catalog, artists, and discography.</p>
            </div>

            <div class="col-md-5 col-lg-4 text-end">
                <button class="btn btn-primary btn-sm px-3 py-1 fw-bold shadow-sm rounded-pill mb-2"
                        data-bs-toggle="collapse" data-bs-target="#createGenre">
                    <i class="bi bi-plus-circle-fill me-1"></i>New Genre
                </button>

                <input type="text"
                       id="adminSearch"
                       class="form-control form-control-sm"
                       placeholder="Search genres, artists, albums, or songs..." />
            </div>
        </div>

        <div class="collapse mb-3" id="createGenre">
            <div class="card card-body border-0 shadow-sm rounded-3 p-2">
                <form asp-action="CreateGenre" method="post" class="row g-2 align-items-end">
                    @Html.AntiForgeryToken()
                    <div class="col-md-9">
                        <label class="form-label fw-bold small text-uppercase">Genre Name</label>
                        <input name="Name" class="form-control form-control-sm" placeholder="e.g. Synthwave" required />
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-dark btn-sm w-100 py-1 fw-bold">Add Genre</button>
                    </div>
                </form>
            </div>
        </div>

        @foreach (var genre in genres)
        {
            <section class="genre-card p-3 mb-2" data-search="@genre.Name">
                <div class="genre-header d-flex justify-content-between align-items-center p-2 rounded-3">
                    <div>
                        <h2 class="h5 fw-bold mb-0">@genre.Name</h2>
                        <span class="opacity-75 small">Genre ID: @genre.Id</span>
                    </div>
                    <div class="d-flex gap-1">
                        <button class="btn btn-white btn-action btn-sm text-warning shadow-sm" data-bs-toggle="collapse" data-bs-target="#editGenre_@genre.Id">
                            <i class="bi bi-pencil-fill"></i>
                        </button>
                        <form asp-action="DeleteGenre" method="post" onsubmit="return confirm('Delete this genre and all its relations?')">
                            @Html.AntiForgeryToken() <input type="hidden" name="id" value="@genre.Id" />
                            <button class="btn btn-white btn-action btn-sm text-danger shadow-sm"><i class="bi bi-trash3-fill"></i></button>
                        </form>
                        <button class="btn btn-dark btn-sm px-2 rounded-pill fw-bold ms-1" data-bs-toggle="collapse" data-bs-target="#addArtist_@genre.Id">
                            <i class="bi bi-person-plus-fill me-1"></i> Add Artist
                        </button>
                    </div>
                </div>

                <div class="p-2">
                    <div class="collapse mb-2" id="editGenre_@genre.Id">
                        <form asp-action="UpdateGenre" method="post" class="p-2 bg-light rounded-3 d-flex gap-2">
                            @Html.AntiForgeryToken() <input type="hidden" name="id" value="@genre.Id" />
                            <input name="name" class="form-control form-control-sm" value="@genre.Name" required />
                            <button class="btn btn-warning btn-sm fw-bold px-2">Update</button>
                        </form>
                    </div>

                    <div class="collapse mb-2" id="addArtist_@genre.Id">
                        <form asp-action="CreateArtist" method="post" class="p-2 border rounded-3 bg-white shadow-sm">
                            @Html.AntiForgeryToken() <input type="hidden" name="GenreIds" value="@genre.Id" />
                            <h5 class="fw-bold mb-2 small"><i class="bi bi-plus-circle me-1"></i>New Artist for @genre.Name</h5>
                            <div class="row g-2">
                                <div class="col-md-6"><label class="form-label small fw-bold">Stage Name</label><input name="Name" class="form-control form-control-sm" required /></div>
                                <div class="col-md-6"><label class="form-label small fw-bold">Photo URL</label><input name="ImageUrl" class="form-control form-control-sm" /></div>
                                <div class="col-12 text-end mt-1"><button class="btn btn-primary btn-sm px-3 rounded-pill fw-bold">Save Artist</button></div>
                            </div>
                        </form>
                    </div>

                    <div class="artist-wrapper">
                        @foreach (var artist in artists.Where(a => a.Genres.Any(g => g.GenreId == genre.Id)))
                        {
                            <div class="artist-item p-2 mb-2" data-search="@artist.Name">
                                <div class="row align-items-center g-2">
                                    <div class="col-auto">
                                        <div class="position-relative">
                                            <img src="@(string.IsNullOrEmpty(artist.ImageUrl) ? "https://ui-avatars.com/api/?name=" + artist.Name : artist.ImageUrl)"
                                                 class="rounded-circle shadow-sm border" width="50" height="50" style="object-fit: cover;">
                                            <span class="position-absolute bottom-0 end-0 badge rounded-pill bg-primary border border-white p-1 small" title="Active Artist">
                                                <i class="bi bi-check-lg"></i>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <h4 class="fw-bold mb-0 fs-6">@artist.Name</h4>
                                        <span class="badge-id small">ARTIST_@artist.Id</span>
                                    </div>
                                    <div class="col-auto d-flex gap-1">
                                        <button class="btn btn-outline-secondary btn-action btn-sm" data-bs-toggle="collapse" data-bs-target="#editArtist_@artist.Id"><i class="bi bi-gear-fill small"></i></button>
                                        <form asp-action="DeleteArtist" method="post">
                                            @Html.AntiForgeryToken() <input type="hidden" name="id" value="@artist.Id" />
                                            <button class="btn btn-outline-danger btn-action btn-sm"><i class="bi bi-trash small"></i></button>
                                        </form>
                                        <button class="btn btn-primary btn-sm rounded-pill px-2 fw-bold shadow-sm" data-bs-toggle="collapse" data-bs-target="#addAlbum_@artist.Id">
                                            <i class="bi bi-disc-fill me-1 small"></i> + Album
                                        </button>
                                    </div>
                                </div>

                                <div class="collapse mt-2" id="editArtist_@artist.Id">
                                    <form asp-action="UpdateArtist" method="post" class="row g-2 p-2 bg-light rounded-3 border">
                                        @Html.AntiForgeryToken() <input type="hidden" name="id" value="@artist.Id" />
                                        <div class="col-md-5"><label class="form-label small fw-bold">Name</label><input name="Name" class="form-control form-control-sm" value="@artist.Name" /></div>
                                        <div class="col-md-5"><label class="form-label small fw-bold">Image URL</label><input name="ImageUrl" class="form-control form-control-sm" value="@artist.ImageUrl" /></div>
                                        <div class="col-md-2 d-flex align-items-end"><button class="btn btn-dark btn-sm w-100 fw-bold">Update</button></div>
                                    </form>
                                </div>

                                <div class="collapse mt-2" id="addAlbum_@artist.Id">
                                    <form asp-action="CreateAlbum" method="post" class="p-2 border-dashed rounded-3 bg-light">
                                        @Html.AntiForgeryToken() <input type="hidden" name="ArtistId" value="@artist.Id" />
                                        <div class="row g-2">
                                            <div class="col-md-4"><label class="form-label small fw-bold">Album Title</label><input name="Title" class="form-control form-control-sm" required /></div>
                                            <div class="col-md-4"><label class="form-label small fw-bold">Cover URL</label><input name="CoverImageUrl" class="form-control form-control-sm" /></div>
                                            <div class="col-md-3"><label class="form-label small fw-bold">Release Date</label><input type="date" name="ReleaseDate" class="form-control form-control-sm" /></div>
                                            <div class="col-md-1 d-flex align-items-end"><button class="btn btn-primary btn-sm w-100 fw-bold">Add</button></div>
                                        </div>
                                    </form>
                                </div>

                                <div class="mt-2 ms-2 ms-md-4">
                                    @foreach (var album in albums.Where(al => al.ArtistId == artist.Id))
                                    {
                                        <div class="album-box p-2 mb-2 shadow-sm" data-search="@album.Title">
                                            <div class="d-flex align-items-center justify-content-between mb-2">
                                                <div class="d-flex align-items-center gap-2">
                                                    <img src="@(string.IsNullOrEmpty(album.CoverImageUrl) ? "https://placehold.co/80x80?text=Album" : album.CoverImageUrl)"
                                                         width="50" height="50" class="rounded-2 shadow-sm border">
                                                    <div>
                                                        <h5 class="fw-bold mb-0 fs-6">@album.Title</h5>
                                                        <small class="text-muted"><i class="bi bi-calendar3 me-1"></i> @album.ReleaseDate.ToShortDateString()</small>
                                                    </div>
                                                </div>
                                                <div class="d-flex gap-1">
                                                    <button class="btn btn-sm btn-link text-warning" data-bs-toggle="collapse" data-bs-target="#editAlbum_@album.Id"><i class="bi bi-pencil-square small"></i></button>
                                                    <form asp-action="DeleteAlbum" method="post" class="d-inline">
                                                        @Html.AntiForgeryToken() <input type="hidden" name="id" value="@album.Id" />
                                                        <button class="btn btn-sm btn-link text-danger"><i class="bi bi-trash3-fill small"></i></button>
                                                    </form>
                                                    <button class="btn btn-sm btn-outline-dark rounded-pill fw-bold" data-bs-toggle="collapse" data-bs-target="#addSong_@album.Id">
                                                        <i class="bi bi-music-note-list me-1 small"></i> Add Song
                                                    </button>
                                                </div>
                                            </div>

                                            <div class="collapse mb-2" id="editAlbum_@album.Id">
                                                <form asp-action="UpdateAlbum" method="post" class="row g-2 p-2 bg-white rounded-2 border">
                                                    @Html.AntiForgeryToken() <input type="hidden" name="id" value="@album.Id" />
                                                    <div class="col-md-4"><input name="Title" class="form-control form-control-sm" value="@album.Title" /></div>
                                                    <div class="col-md-4"><input name="CoverImageUrl" class="form-control form-control-sm" value="@album.CoverImageUrl" /></div>
                                                    <div class="col-md-3"><input type="date" name="ReleaseDate" class="form-control form-control-sm" value="@album.ReleaseDate.ToString("yyyy-MM-dd")" /></div>
                                                    <div class="col-md-1"><button class="btn btn-warning btn-sm w-100">OK</button></div>
                                                </form>
                                            </div>

                                            <div class="collapse mb-2" id="addSong_@album.Id">
                                                <form asp-action="CreateSong" method="post" class="row g-2 p-2 bg-dark rounded-2">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="ArtistId" value="@artist.Id" />
                                                    <input type="hidden" name="AlbumId" value="@album.Id" />
                                                    <div class="col-md-5"><input name="Title" class="form-control form-control-sm bg-transparent text-white border-secondary" placeholder="Song Title" required /></div>
                                                    <div class="col-md-3"><input name="Duration" class="form-control form-control-sm bg-transparent text-white border-secondary" placeholder="00:03:30" /></div>
                                                    <div class="col-md-3"><input name="DeezerTrackId" class="form-control form-control-sm bg-transparent text-white border-secondary" placeholder="Deezer ID" /></div>
                                                    <div class="col-md-1"><button class="btn btn-primary btn-sm w-100">Add</button></div>
                                                </form>
                                            </div>

                                            <div class="table-responsive song-table border">
                                                <table class="table table-hover table-borderless table-sm mb-0">
                                                    <thead>
                                                        <tr class="small text-muted text-uppercase">
                                                            <th class="ps-2">Track</th>
                                                            <th>Length</th>
                                                            <th>Link ID</th>
                                                            <th class="text-end pe-2">Manage</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var song in songs.Where(s => s.AlbumId == album.Id))
                                                        {
                                                            <tr data-search="@song.Title">


                                                                <td class="ps-2 fw-semibold"><i class="bi bi-play-circle-fill text-primary me-1"></i>@song.Title</td>
                                                                <td><span class="badge bg-light text-dark small">@song.Duration.ToString(@"hh\:mm\:ss")</span></td>
                                                                <td><code class="small text-muted">@song.DeezerTrackId</code></td>
                                                                <td class="text-end pe-2">
                                                                    <button class="btn btn-sm btn-light text-warning me-1" data-bs-toggle="collapse" data-bs-target="#editSong_@song.Id"><i class="bi bi-pencil-fill small"></i></button>
                                                                    <form asp-action="DeleteSong" method="post" class="d-inline">
                                                                        @Html.AntiForgeryToken() <input type="hidden" name="id" value="@song.Id" />
                                                                        <button class="btn btn-sm btn-light text-danger"><i class="bi bi-x-lg small"></i></button>
                                                                    </form>
                                                                </td>
                                                            </tr>
                                                            <tr class="collapse" id="editSong_@song.Id">
                                                                <td colspan="4" class="bg-light p-2 border-top">
                                                                    <form asp-action="UpdateSong" method="post" class="row g-2">
                                                                        @Html.AntiForgeryToken() <input type="hidden" name="id" value="@song.Id" />
                                                                        <div class="col-md-4"><input name="Title" class="form-control form-control-sm" value="@song.Title" /></div>
                                                                        <div class="col-md-3"><input name="Duration" class="form-control form-control-sm" value="@song.Duration.ToString(@"hh\:mm\:ss")" /></div>
                                                                        <div class="col-md-3"><input name="DeezerTrackId" class="form-control form-control-sm" value="@song.DeezerTrackId" /></div>
                                                                        <div class="col-md-2"><button class="btn btn-warning btn-sm w-100 fw-bold">Update</button></div>
                                                                    </form>
                                                                </td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </section>
        }
    </div>
</div>
<script>
    const searchInput = document.getElementById("adminSearch");

    searchInput.addEventListener("keyup", function () {
        const query = this.value.trim().toLowerCase();

        const genres  = document.querySelectorAll(".genre-card");
        const artists = document.querySelectorAll(".artist-item");
        const albums  = document.querySelectorAll(".album-box");
        const songs   = document.querySelectorAll("tr[data-search]");

        // Reset
        if (!query) {
            [...genres, ...artists, ...albums, ...songs]
                .forEach(el => el.style.display = "");
            return;
        }

        // Hide everything
        [...genres, ...artists, ...albums, ...songs]
            .forEach(el => el.style.display = "none");

        document.querySelectorAll("[data-search]").forEach(el => {
            if (!el.dataset.search.toLowerCase().includes(query)) return;

            // Show matched element
            el.style.display = "";

            // Show parents explicitly (no loops)
            const album  = el.closest(".album-box");
            const artist = el.closest(".artist-item");
            const genre  = el.closest(".genre-card");

            if (album)  album.style.display  = "";
            if (artist) artist.style.display = "";
            if (genre)  genre.style.display  = "";

            // Show children ONLY of the matched element
            if (el.classList.contains("genre-card")) {
                el.querySelectorAll(".artist-item, .album-box, tr[data-search]")
                  .forEach(c => c.style.display = "");
            }

            if (el.classList.contains("artist-item")) {
                el.querySelectorAll(".album-box, tr[data-search]")
                  .forEach(c => c.style.display = "");
            }

            if (el.classList.contains("album-box")) {
                el.querySelectorAll("tr[data-search]")
                  .forEach(c => c.style.display = "");
            }
        });
    });
</script>
